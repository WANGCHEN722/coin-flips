<!DOCTYPE html>
<html>

<head>
  <style>
    table {
      border-collapse: collapse;
      border: 2px solid rgb(140 140 140);
      font-family: sans-serif;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    caption {
      caption-side: bottom;
      padding: 10px;
      font-weight: bold;
    }

    thead,
    tfoot {
      background-color: rgb(228 240 245);
    }

    th,
    td {
      border: 1px solid rgb(160 160 160);
      padding: 8px 10px;
    }

    td:last-of-type {
      text-align: center;
    }

    tbody>tr:nth-of-type(even) {
      background-color: rgb(237 238 242);
    }

    tfoot th {
      text-align: right;
    }

    tfoot td {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="coinFlip"></div>

  <div id="groupName">
    <input type="text" placeholder="Enter group name" id="groupNameInput"></input>
    <button onclick="login()">Confirm</button>
    <p id="groupReminder"></p>
  </div>

  <template id="renderCoin">
    <canvas id="coinAnim" width="100" height="100"></canvas>
    <button onclick="startflip()">Flip!</button>
    <p id="result"></p>
  </template>

  <template id="groupTable">
    <table>
      <thead>
        <tr>
          <th scope="col">Group</th>
          <th scope="col"> No. Heads</th>
          <th scope="col">No. Tails</th>
        </tr>
      </thead>
      <tbody id="tableData">
      </tbody>
    </table>
  </template>

  <template id="tableRow">
    <tr>
      <th scope="row"></th>
      <td></td>
      <td></td>
    </tr>
  </template>


  <script>
    var groupId
    var ctx
    const url = "http://127.0.0.1:8000/"


    function drawCoin() {
      ctx.save()
      ctx.setTransform(1, 0, 0, 1, 0, 0)
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
      ctx.restore()

      ctx.beginPath()
      ctx.arc(0, 0, 40, 0, 2 * Math.PI)
      ctx.stroke()
      ctx.fillStyle = "yellow"
      ctx.fill()

      ctx.font = "50px serif"
      ctx.textAlign = "center"
      ctx.textBaseline = "middle"
      ctx.fillStyle = "black"
      ctx.fillText("$", 0, 0)
    }

    function login() {
      let name = document.getElementById("groupNameInput").value
      if (name) {
        groupId = name
        document.getElementById("groupName").innerHTML = ''

        let clone = document.getElementById("renderCoin").content.cloneNode(true)
        document.getElementById("coinFlip").appendChild(clone)
        clone = document.getElementById("groupTable").content.cloneNode(true)
        document.getElementById("groupName").appendChild(clone)

        ctx = document.getElementById("coinAnim").getContext("2d")
        ctx.setTransform(1, 0, 0, 1, ctx.canvas.width / 2, ctx.canvas.height / 2)
        drawCoin()
        populateTable()
        setInterval(populateTable, 1000)
      } else {
        document.getElementById("groupReminder").innerHTML = "Please enter a group name"
      }
    }

    function generateNormal() {
      return Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random())
    }

    let t, rot, cos, sin, cross, start
    let x, y, z
    let force
    var done = true

    async function startflip() {
      if (done) {
        done = false
        x = generateNormal()
        y = generateNormal()
        z = generateNormal()

        let scale = 1 / Math.sqrt(x ** 2 + y ** 2 + z ** 2);
        x = x * scale
        y = y * scale
        z = z * scale
        force = Math.exp(generateNormal() + 2)
        window.requestAnimationFrame(renderflip)

        await new Promise(r => setTimeout(r, 600))
        fetch(url + "flip?id=" + groupId, { method: "POST" })
          .then(response => { done = true; start = undefined; return response.json() })
          .then(json => { document.getElementById("result").innerHTML = "You got " + json + "s!" })
          .catch(err => { done = true; start = undefined; console.error(err) })
      }
    }

    function renderflip(time) {

      if (start === undefined) {
        start = time
      }

      t = (time - start) * 0.001
      rot = t * force
      cos = Math.cos(rot)
      sin = Math.sin(rot)
      cross = x * y

      ctx.setTransform(1, 0, 0, 1, ctx.canvas.width / 2, ctx.canvas.height / 2)
      ctx.transform(x ** 2 * (1 - cos) + cos, cross * (1 - cos) + z * sin, cross * (1 - cos) - z * sin, y ** 2 * (1 - cos) + cos, 0, 0)
      drawCoin()
      if (!done) {
        window.requestAnimationFrame(renderflip)
      } else {
        start = undefined
      }
    }

    async function populateTable() {
      let data = document.getElementById("tableData")
      let clone, row
      let children = [];

      for (group of await fetch(url + "groups").then(response => response.json())) {
        if (group != groupId) {
          children.push(await getrow(group))
        }
      }

      let first_row = await getrow(groupId)
      data.innerHTML = ''
      data.appendChild(first_row)
      children.forEach(child => { data.appendChild(child) })


    }

    async function getrow(id) {
      let clone = document.getElementById("tableRow").content.cloneNode(true)
      let row = clone.childNodes[1]
      row.childNodes[1].innerHTML = id
      let nums = await fetch(url + "count?id=" + id).then(response => response.json())
      row.childNodes[3].innerHTML = nums.heads
      row.childNodes[5].innerHTML = nums.tails
      return clone
    }
  </script>
</body>

</html>